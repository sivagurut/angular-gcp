steps:
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build','-t', 'gcr.io/$PROJECT_ID/app-angular-gcp-ui:v2', . ]
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'push', 'gcr.io/$PROJECT_ID/app-angular-gcp-ui:v2']
- id: 'deploy'
  name: 'gcr.io/cloud-builders/gcloud'
  env:
   - 'CLOUDSDK_CONTAINER_CLUSTER=demo-cluster'
   - 'KUBECONFIG=/kube/config'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
        CLUSTER=$$(gcloud config get-value container/cluster)
        PROJECT=$$(gcloud config get-value core/project)
        ZONE=$$(gcloud config get-value compute/zone) 
        
        gcloud container clusters get-credentials demo-cluster  \
            --project elevated-server-275615 \
            --zone us-central1-c     
                
        
        sed -i 's|gcr.io/"$${PROJECT}"/app-angular-gcp-ui:.*|gcr.io/"$${PROJECT}"/app-angular-gcp-ui:v2|' ./manifest.yaml
        
        kubectl delete deployment app-angular-gcp-ui
        kubectl get ns default || kubectl create ns default
        kubectl apply --namespace default --recursive -f manifest.yaml
images:
- gcr.io/$PROJECT_ID/app-angular-gcp-ui:v2
